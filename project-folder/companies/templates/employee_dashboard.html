{% extends "base.html" %}

{% block content %}
    <h2>Employee Dashboard</h2>
    {% if user.is_authenticated %}
        <p> Utente : {{user.username}}</p>
        <p> Dipendente di : {{user.employee_profile.company.name}}</p>
        

        <h3>Open Tickets</h3>
        <ul>
            {% for ticket in open_tickets %}
                <li>
                    <a href="#" onclick="openChatModal('{{ ticket.id }}')">{{ ticket.title }} - {{ ticket.description }}</a>
                </li>
            {% endfor %}
        </ul>
        
        <!-- Modal Pop-up per la Chat -->
        <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chatModalLabel">Chat for Ticket #<span id="modalTicketId"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="chatMessages" class="chat-messages" style="height: 300px; overflow-y: auto;">
                            <!-- Messaggi della chat verranno caricati qui -->
                        </div>
                        <form id="chatForm" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="ticket_id" id="chatTicketId">
                            <div class="input-group mt-3">
                                <textarea class="form-control" name="content" id="chatMessageContent" rows="2" placeholder="Type your message"></textarea>
                                <button class="btn btn-primary" type="submit">Send</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            function openChatModal(ticketId) {
                // Imposta l'ID del ticket nel modal
                document.getElementById('modalTicketId').textContent = ticketId;
                document.getElementById('chatTicketId').value = ticketId;
                
                // Effettua una richiesta AJAX per ottenere i messaggi della chat
                fetch(`/tickets/${ticketId}/messages/`)
                    .then(response => response.json())
                    .then(data => {
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.innerHTML = ''; // Resetta i messaggi
        
                        // Inserisci i messaggi nel modal
                        data.messages.forEach(message => {
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('chat-message');
                            messageElement.innerHTML = `<strong>${message.sender__username}:</strong> ${message.content} <small>${message.timestamp}</small>`;
                            chatMessages.appendChild(messageElement);
                        });
        
                        // Scrolla alla fine dei messaggi
                        chatMessages.scrollTop = chatMessages.scrollHeight;
        
                        // Apri il modal
                        const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
                        chatModal.show();
                    });
            }
        
            // Gestisce l'invio del messaggio
            document.getElementById('chatForm').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(this);
                
                fetch(`/tickets/${formData.get('ticket_id')}/send_message/`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        openChatModal(formData.get('ticket_id'));  // Ricarica i messaggi
                        document.getElementById('chatMessageContent').value = '';  // Resetta il campo messaggio
                    }
                });
            });
        </script>


        <h3>Pending Tickets</h3>
        <table>
            <tbody>
                {% for ticket in pending_tickets %}
                    <tr>
                        <td>{{ ticket.title }} </td>
                        <td>{{ ticket.description }} </td>
                        <td>
                            <form method="POST" action="{% url 'accept-ticket' ticket.id %}">
                                {% csrf_token %}
                                <button type="submit">Accept</button>
                            </form>
                        </td>
                        <td>
                            <form id="close-ticket-form" method="POST" action="{% url 'close-ticket' ticket.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="close_reason" id="close-reason">
                                <button type="button" onclick="submitCloseForm('{{ ticket.id }}')">Reject</button>
                            </form>
                        </td>

                        <script>
                            function submitCloseForm(ticketId) {
                                var reason = prompt("Please enter the reason for rejection:");
                                if (reason !== null && reason.trim() !== "") {
                                    // Set the reason in the hidden input field
                                    document.getElementById('close-reason').value = reason;
                                    // Submit the form
                                    document.getElementById('close-ticket-form').submit();
                                } else {
                                    alert("You must provide a reason to close the ticket.");
                                }
                            }
                        </script>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Closed Tickets</h3>
        <ul>    
            {% for ticket in closed_tickets %}
            <li>
                {{ ticket.title }} - {{ ticket.description }} 
                    <br>
                    Created : {{ ticket.created_at }}
            </li>
            {% endfor %}
        </ul>
 
        <h3>Already Handled Tickets</h3>
        <ul>        
            {% for ticket in already_handled_tickets %}
            <li>
                {{ ticket.title }} - {{ ticket.description }} 
                    <br>
                    Created : {{ ticket.created_at }}
            </li>
            {% endfor %}
        </ul>
    {% endif %}
{% endblock %}