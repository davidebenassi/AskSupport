{% extends "base.html" %}

{% block content %}
    <h2>Employee Dashboard</h2>
    {% if user.is_authenticated %}
        <p> Utente : {{user.username}}</p>
        <p> Dipendente di : {{user.employee_profile.company.name}}</p>
        

        <h3>Open Tickets</h3>
        <ul>
            {% for ticket in open_tickets %}
                <li>
                    {{ ticket.title }} - {{ ticket.description }} 
                </li>
            {% endfor %}    
        </ul>


        <h3>Pending Tickets</h3>
        <table>
            <tbody>
                {% for ticket in pending_tickets %}
                    <tr>
                        <td>{{ ticket.title }} </td>
                        <td>{{ ticket.description }} </td>
                        <td>
                            <form method="POST" action="{% url 'accept-ticket' ticket.id %}">
                                {% csrf_token %}
                                <button type="submit">Accept</button>
                            </form>
                        </td>
                        <td>
                            <form id="close-ticket-form" method="POST" action="{% url 'close-ticket' ticket.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="close_reason" id="close-reason">
                                <button type="button" onclick="submitCloseForm('{{ ticket.id }}')">Reject</button>
                            </form>
                        </td>

                        <script>
                            function submitCloseForm(ticketId) {
                                var reason = prompt("Please enter the reason for rejection:");
                                if (reason !== null && reason.trim() !== "") {
                                    // Set the reason in the hidden input field
                                    document.getElementById('close-reason').value = reason;
                                    // Submit the form
                                    document.getElementById('close-ticket-form').submit();
                                } else {
                                    alert("You must provide a reason to close the ticket.");
                                }
                            }
                        </script>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Closed Tickets</h3>
        <ul>    
            {% for ticket in closed_tickets %}
            <li>
                {{ ticket.title }} - {{ ticket.description }} 
                    <br>
                    Created : {{ ticket.created_at }}
            </li>
            {% endfor %}
        </ul>
 
        <h3>Already Handled Tickets</h3>
        <ul>        
            {% for ticket in already_handled_tickets %}
            <li>
                {{ ticket.title }} - {{ ticket.description }} 
                    <br>
                    Created : {{ ticket.created_at }}
            </li>
            {% endfor %}
        </ul>
    {% endif %}
{% endblock %}